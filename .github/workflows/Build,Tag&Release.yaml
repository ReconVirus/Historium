name: Build, Tag and Release

on:
    push:
        branches:
            - Main

env:
    ARTIFACT_PATH: ./dist/
    ZIP_FILE_NAME: release

jobs:
    build:
        name: Build release artifacts
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: 'npm'
            - uses: actions/cache@v3
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-
            - run: npm ci
            - run: |
                  npm run build
                  cp ./manifest.json ./dist/
            - uses: actions/upload-artifact@v3
              with:
                  name: Release
                  path: ./dist

    tag:
        needs: build
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: 'npm'
            - uses: actions/download-artifact@v3
              with:
                  name: Release
                  path: ./dist

            - id: release_type
              shell: pwsh
              run: |
                  $changelog = Get-Content -Path ./CHANGELOG.md -Raw
                  if ($changelog -match '### Fixed') {
                    echo "release_type=patch" | Out-File -FilePath $env:GITHUB_ENV -Append
                  } elseif ($changelog -match '### Added') {
                    echo "release_type=minor" | Out-File -FilePath $env:GITHUB_ENV -Append
                  } elseif ($changelog -match '### Changed') {
                    echo "release_type=major" | Out-File -FilePath $env:GITHUB_ENV -Append
                  } else {
                    default { $NEW_TAG = "v$($VERSION[0]).$(1 + [int]$VERSION[1]).0" }
                  }
            - shell: pwsh
              run: |
                  $VERSION = (Get-Content package.json | ConvertFrom-Json).version -split '\.'
                  $RELEASE_TYPE = "${{ github.ref }}"

                  switch ($RELEASE_TYPE) {
                    "major" { $NEW_TAG = "v$(1 + [int]$VERSION[0]).0.0" }
                    "minor" { $NEW_TAG = "v$($VERSION[0]).$(1 + [int]$VERSION[1]).0" }
                    "patch" { $NEW_TAG = "v$($VERSION[0]).$($VERSION[1]).$(1 + [int]$VERSION[2])" }
                    default { $NEW_TAG = "v$($VERSION[0]).$(1 + [int]$VERSION[1]).0" }
                  }

                  git tag $NEW_TAG
                  git push origin $NEW_TAG

            - id: set_tag
              run:  echo "latest_tag=$NEW_TAG" >> $GITHUB_ENV
              shell: pwsh

        outputs:
            latest_tag: ${{ steps.set_tag.outputs.latest_tag }}

    release:
        needs: tag
        runs-on: windows-latest
        steps:
            - id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ needs.tag.outputs.latest_tag }}
                  release_name: Release ${{ needs.tag.outputs.latest_tag }}
                  body_path: CHANGELOG.md
                  draft: false
                  prerelease: false
