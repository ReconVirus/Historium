name: Build, Tag and Release

on:
    push:
        branches:
            - Main

env:
    ARTIFACT_PATH: ./dist/
    ZIP_FILE_NAME: release

jobs:
    build:
        name: Build release artifacts
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                node-version: '18'
                cache: 'npm'
            - name: Cache node modules
              uses: actions/cache@v3
              with:
                path: ~/.npm
                key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                restore-keys: |
                  ${{ runner.os }}-node-
            - run: npm ci
            - run: |
                npm run build
                cp ./manifest.json ./dist/
              shell: pwsh
            - uses: actions/upload-artifact@v3.1.3
              with:
                name: Release
                path: ./dist

    tag_and_release:
        needs: build
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                node-version: '18'
                cache: 'npm'
            - uses: actions/download-artifact@v3.0.2
              with:
                name: Release
                path: ./
            - id: set_tag_and_push
              shell: pwsh
              run: |
                $VERSION = (Get-Content package.json | ConvertFrom-Json).version
                echo "latest_tag=v$VERSION" >> $GITHUB_ENV

                git remote set-url origin "https://x-access-token:${{ secrets.MASTER }}@github.com/ReconVirus/Historium.git"
                git tag v$VERSION
                git push origin v$VERSION

            - run: echo ${{ env.latest_tag }}
              shell: pwsh

            - id: create_release_and_upload_asset
              uses: actions/create-release@v1
              env:
                GITHUB_TOKEN: ${{ secrets.MASTER }}
              with:
                tag_name: ${{ env.latest_tag }}
                release_name: Release ${{ env.latest_tag }}
                body_path: CHANGELOG.md
                draft: false
                prerelease: false

            - name: Upload Release Asset and Individual Files as Assets
              run: |
                  # Upload the zip file as a release asset.
                  curl \
                    --request POST \
                    --header "Authorization: token ${{ secrets.MASTER }}" \
                    --header "Content-Type: $(file -b --mime-type ${ZIP_FILE_NAME}.zip)" \
                    --data-binary "@${ZIP_FILE_NAME}.zip" \
                    "${{ steps.create_release_and_upload_asset.outputs.upload_url }}/assets?name=${ZIP_FILE_NAME}.zip"

                  # Unzip the file.
                  unzip ${ZIP_FILE_NAME}.zip -d dist/

                  # Upload individual files as release assets.
                  for filename in dist/*; do 
                      curl \
                        --request POST \
                        --header "Authorization: token ${{ secrets.MASTER }}" \
                        --header "Content-Type: $(file -b --mime-type $filename)" \
                        --data-binary "@$filename" \
                        "${{ steps.create_release_and_upload_asset.outputs.upload_url }}/assets?name=$(basename $filename)"
                  done;

              shell: bash

